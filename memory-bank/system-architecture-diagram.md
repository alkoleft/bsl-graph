# Архитектурная диаграмма системы анализа конфигураций 1С

## Общая архитектура системы

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           ПРЕЗЕНТАЦИОННЫЙ СЛОЙ                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   Веб-интерфейс │  │   REST API      │  │   MCP Protocol  │  │  Console CLI │ │
│  │   (Sigma.js)    │  │   Controllers   │  │   Controller    │  │  Controller  │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              ДОМЕННЫЙ СЛОЙ                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   GraphNode     │  │   CodeNode      │  │   QueryNode     │  │SerializedObj │ │
│  │   (метаданные)  │  │   (код)         │  │   (запросы)     │  │   (JSON)     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └──────────────┘ │
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │MetadataService  │  │CodeAnalysisSvc  │  │QueryAnalysisSvc │  │Configuration │ │
│  │                 │  │                 │  │                 │  │RAGService    │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           ИНФРАСТРУКТУРНЫЙ СЛОЙ                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │  MetadataExporter│  │ObjectSerializat│  │CodeGraphBuilder │  │QueryParser   │ │
│  │  (bsl-mdclasses)│  │  ionService     │  │  Visitor        │  │  (ANTLR)     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └──────────────┘ │
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │JsonDbRepository │  │EmbeddingService │  │VectorDatabase   │  │SearchRanking │ │
│  │  (MongoDB)      │  │(sentence-transf)│  │  (ChromaDB)     │  │  Service     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              СЛОЙ ДАННЫХ                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   NebulaGraph   │  │   MongoDB       │  │   ChromaDB      │  │  File System │ │
│  │   (граф знаний) │  │   (JSON данные) │  │   (векторы)     │  │  (конфиги)   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Детальная архитектура компонентов

### 1. Слой данных

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              ХРАНИЛИЩА ДАННЫХ                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                           NEBULA GRAPH                                     │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │ │
│  │  │   Узлы      │  │   Ребра     │  │   Теги      │  │     Схема           │ │ │
│  │  │             │  │             │  │             │  │                     │ │ │
│  │  │ • Configuration │ • CONTAINS  │ • Configuration │ • Node Types         │ │ │
│  │  │ • Catalog    │  │ • HAS_FORM │  │ • Catalog    │  │ • Edge Types        │ │ │
│  │  │ • Document   │  │ • CALLS    │  │ • Document   │  │ • Properties        │ │ │
│  │  │ • Procedure  │  │ • USES     │  │ • Procedure  │  │ • Indexes           │ │ │
│  │  │ • Query      │  │ • RELATED  │  │ • Query      │  │                     │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                            MONGODB                                         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │ │
│  │  │ Коллекции   │  │   Индексы   │  │   Поиск     │  │     Версионность    │ │ │
│  │  │             │  │             │  │             │  │                     │ │ │
│  │  │ • configurations │ • name_idx  │ • Full-text  │  │ • version field     │ │ │
│  │  │ • catalogs   │  │ • uuid_idx  │  │ • Metadata  │  │ • lastModified      │ │ │
│  │  │ • documents  │  │ • type_idx  │  │ • Content   │  │ • checksum          │ │ │
│  │  │ • procedures │  │ • parent_idx│  │ • Semantic  │  │ • change tracking   │ │ │
│  │  │ • queries    │  │ • content_idx│  │             │  │                     │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                           CHROMADB                                         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │ │
│  │  │  Коллекции  │  │  Embeddings │  │   Поиск     │  │     Метаданные      │ │ │
│  │  │             │  │             │  │             │  │                     │ │ │
│  │  │ • metadata  │  │ • 384 dim   │  │ • Similarity│  │ • object_id         │ │ │
│  │  │ • code      │  │ • 768 dim   │  │ • Semantic  │  │ • content_type      │ │ │
│  │  │ • queries   │  │ • 1024 dim  │  │ • Hybrid    │  │ • source_file       │ │ │
│  │  │ • comments  │  │ • Multilingual│  │ • Ranking  │  │ • created_at        │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2. Поток данных

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              ПОТОК ОБРАБОТКИ ДАННЫХ                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────────┐ │
│  │ Конфигурация│    │   Парсинг   │    │  Анализ     │    │   Сохранение    │ │
│  │    1С       │───▶│  метаданных │───▶│  структуры  │───▶│   в граф        │ │
│  │             │    │             │    │             │    │                 │ │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────────┘ │
│         │                   │                   │                   │         │
│         │                   │                   │                   │         │
│         ▼                   ▼                   ▼                   ▼         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────────┐ │
│  │   Модули    │    │   BSL       │    │  AST        │    │   JSON DB       │ │
│  │   кода      │───▶│  Parser     │───▶│  анализ     │───▶│   (MongoDB)     │ │
│  │             │    │             │    │             │    │                 │ │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────────┘ │
│         │                   │                   │                   │         │
│         │                   │                   │                   │         │
│         ▼                   ▼                   ▼                   ▼         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────────┐ │
│  │   Запросы   │    │   Query     │    │  Query      │    │   Векторная     │ │
│  │   (SQL)     │───▶│  Parser     │───▶│  анализ     │───▶│   БД (Chroma)   │ │
│  │             │    │  (ANTLR)    │    │             │    │                 │ │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────────┘ │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3. API и интерфейсы

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              API И ИНТЕРФЕЙСЫ                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                           REST API                                         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │ │
│  │  │   Graph     │  │    Code     │  │   Query     │  │        RAG          │ │ │
│  │  │   API       │  │    API      │  │    API      │  │        API          │ │ │
│  │  │             │  │             │  │             │  │                     │ │ │
│  │  │ GET /graph  │  │ GET /code   │  │ GET /query  │  │ POST /search        │ │ │
│  │  │ POST /graph │  │ POST /analyze│ │ POST /parse │  │ GET /index          │ │ │
│  │  │ GET /nodes  │  │ GET /procedures│ GET /tables │  │ GET /similar        │ │ │
│  │  │ GET /edges  │  │ GET /calls  │  │ GET /fields │  │ POST /embed         │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                           MCP PROTOCOL                                     │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │ │
│  │  │   Tools     │  │  Resources  │  │  Prompts    │  │      Logging        │ │ │
│  │  │             │  │             │  │             │  │                     │ │ │
│  │  │ analyze_config│ get_metadata │  │ search_prompt│  │ debug_logs          │ │ │
│  │  │ search_code │  │ get_code    │  │ code_prompt  │  │ error_logs          │ │ │
│  │  │ find_queries│  │ get_queries │  │ query_prompt │  │ performance_logs    │ │ │
│  │  │ rag_search  │  │ get_vectors │  │ help_prompt  │  │ audit_logs          │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        ВЕБ-ИНТЕРФЕЙС                                        │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │ │
│  │  │   Граф      │  │    Код      │  │   Поиск     │  │      Настройки     │ │ │
│  │  │ Визуализация│  │ Анализ      │  │   RAG       │  │                     │ │ │
│  │  │             │  │             │  │             │  │                     │ │ │
│  │  │ • Sigma.js  │  │ • Syntax    │  │ • Search    │  │ • Configuration     │ │ │
│  │  │ • D3.js     │  │   Highlight │  │   Interface │  │ • Database          │ │ │
│  │  │ • Zoom      │  │ • Call Graph│  │ • Results   │  │ • Indexing          │ │ │
│  │  │ • Filter    │  │ • AST Tree  │  │   Ranking   │  │ • Performance       │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Технологический стек

### Backend
- **Kotlin 2.1.20** - основной язык
- **Spring Boot 3.5.0** - фреймворк
- **NebulaGraph 3.0.0** - графовая БД
- **MongoDB 7.0** - JSON БД
- **ChromaDB** - векторная БД
- **bsl-mdclasses** - работа с метаданными 1С
- **bsl-parser** - парсинг BSL кода
- **ANTLR** - парсинг запросов

### Frontend
- **TypeScript** - язык
- **Vite** - сборщик
- **Sigma.js** - визуализация графов
- **React** - UI фреймворк (опционально)

### AI/ML
- **sentence-transformers** - embeddings
- **ChromaDB** - векторный поиск
- **RAG** - Retrieval Augmented Generation

### DevOps
- **Docker** - контейнеризация
- **Gradle** - сборка
- **JUnit 5** - тестирование
- **JaCoCo** - покрытие кода

## Масштабируемость

### Горизонтальное масштабирование
- **MongoDB Sharding** - для больших объемов данных
- **NebulaGraph Cluster** - для больших графов
- **ChromaDB Cluster** - для векторного поиска
- **Load Balancer** - для API

### Вертикальное масштабирование
- **Кэширование** - Redis для частых запросов
- **Индексы** - оптимизация запросов
- **Партиционирование** - по конфигурациям
- **Асинхронная обработка** - для больших файлов

Эта архитектура обеспечивает полный цикл анализа конфигураций 1С с поддержкой всех требуемых функций: графов метаданных, анализа кода, запросов и интеллектуального поиска.
